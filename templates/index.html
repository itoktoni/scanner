<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>Stock Screener IDX</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous">

  <!-- DataTables + Bootstrap 5 CSS -->
  <link rel="stylesheet"
        href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet"
        href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

  <style>
    body {
      background-color: #f8f9fa;
    }
    .card {
      margin-bottom: 1.5rem;
    }
    .table-responsive {
      margin-top: 1rem;
    }
    @media (max-width: 576px) {
      h2 {
        font-size: 1.4rem;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">IDX Screener</a>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row g-3">
      <!-- Form panel -->
      <div class="col-12 col-lg-2">
        <div class="card shadow-sm">
          <div class="card-header">
            <h5 class="mb-0">Parameter Scan & Backtest</h5>
          </div>
          <div class="card-body">
            <form id="scan-form" class="row g-3">
              <div class="col-12">
                <label class="form-label">Tickers (multiple, boleh kosong)</label>
                <select name="tickers" id="tickers-select" class="form-select" multiple>
                  {% for item in all_tickers %}
                  <option value="{{ item.symbol }}">{{ item.symbol }}{% if syariah_tickers and item.symbol not in syariah_tickers %}*{% endif %}</option>
                  {% endfor %}
                </select>
                <small class="text-muted">
                  *) Non-Syariah. Jika tidak memilih apa pun, sistem akan memakai semua emiten di list ini.
                </small>
              </div>

              <div class="col-12">
                <label class="form-label">Strategy</label>
                <select name="strategy" class="form-select">
                  {% for key, cfg in strategies.items() %}
                  <option value="{{ key }}">{{ cfg.name or key }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-12">
                <label class="form-label">Amount per Trade (Rp)</label>
                <input type="number" name="amount" class="form-control" value="1000000">
              </div>

              <div class="col-12">
                <label class="form-label">Backtest Period</label>
                <select name="bt_period" class="form-select">
                  <option value="1m">1 Month</option>
                  <option value="3m">3 Month</option>
                  <option value="6m">6 Month</option>
                  <option value="12m">1 year</option>
                  <option value="22m">2 Year</option>
                </select>
              </div>

              <div class="col-12">
                <label class="form-label">Timeframe</label>
                <select name="timeframe" class="form-select">
                  <option value="5m">5 Minutes</option>
                  <option value="30m">30 Minutes</option>
                  <option value="1h">1 Hour</option>
                  <option value="4h">4 Hours</option>
                  <option value="6h">6 Hours</option>
                  <option value="12h">12 Hours</option>
                  <option value="1d" selected>1 Day</option>
                  <option value="3d">3 Days</option>
                  <option value="7d">7 Days</option>
                  <option value="1m">1 Month</option>
                </select>
              </div>

              <div class="col-12 d-flex gap-2">
                <button type="button" id="btn-scan" class="btn btn-primary flex-fill">
                  Scan
                </button>
                <button type="button" id="btn-backtest" class="btn btn-outline-success flex-fill">
                  Backtest
                </button>
              </div>
            </form>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-header">
            <h6 class="mb-0">Backtest Summary</h6>
          </div>
          <div class="card-body">
            <pre id="summary-box" class="mb-0 small" style="white-space: pre-wrap;"></pre>
          </div>
        </div>
      </div>

      <!-- Table panel -->
      <div class="col-12 col-lg-10">
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Result</h5>
            <span class="badge bg-secondary" id="mode-badge">Mode: Scan</span>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table id="result-table" class="table table-striped table-bordered table-hover nowrap" style="width:100%">
                <thead class="table-light">
                  <tr>
                    <th>Ticker</th>
                    <th>Price</th>
                    <th>Entry</th>
                    <th>SL</th>
                    <th>TP</th>
                    <th>TP %</th>
                    <th>TP Rp</th>
                    <th>SL %</th>
                    <th>SL Rp</th>
                    <th>PnL</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Hold</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <small class="text-muted">
              • Mode Scan: 1 baris per ticker (kondisi sekarang; hanya jika memenuhi strategy).<br>
              • Mode Backtest: 1 baris per trade (historis, termasuk SL/TP saat entry).<br>
              • *) Menandakan saham non-syariah.
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS: jQuery + Bootstrap + DataTables + Select2 -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
          crossorigin="anonymous"></script>

  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script>
    // Helper: format angka jadi Rupiah (1.000.000)
    function formatRupiah(num) {
      if (num === null || num === undefined || isNaN(num)) return "";
      return Number(num).toLocaleString('id-ID');
    }

    // Init Select2 multiple select + search
    $(document).ready(function() {
      $('#tickers-select').select2({
        theme: 'bootstrap-5',
        placeholder: 'Pilih tickers (boleh lebih dari satu)',
        allowClear: true,
        width: '100%'
      });
    });

    let table = $('#result-table').DataTable({
      responsive: true,
      autoWidth: false,
      pageLength: 25,
      lengthMenu: [10, 25, 50, 100]
    });

    function submitForm(action) {
      $('#mode-badge').text("Mode: " + (action === "backtest" ? "Backtest" : "Scan"));

      // Serialize form + gabungkan tickers multiple select ke "tickers" (comma-separated)
      let formData = $('#scan-form').serializeArray();
      let selectedTickers = $('#tickers-select').val() || [];
      formData = formData.filter(f => f.name !== 'tickers');
      formData.push({name: 'tickers', value: selectedTickers.join(',')});
      formData.push({name: 'action', value: action});

      $.post("/", formData, function(res) {
        if (res.error) {
          alert(res.error);
          return;
        }

        table.clear();

        if (action === "backtest") {
          // MODE BACKTEST: satu baris per trade (dengan SL & TP historis)
          res.backtest_trades.forEach(r => {
            let cleanTicker = r.ticker.replace(/\*/g, '');
            table.row.add([
              '<a href="https://stockbit.com/symbol/' + cleanTicker + '/chartbit" target="_blank">' + r.ticker + '</a>',
              r.exit_price !== null ? r.exit_price.toFixed(2) : "",
              r.entry_price !== null ? r.entry_price.toFixed(2) : "",
              r.stop_loss !== null ? r.stop_loss.toFixed(2) : "",
              r.take_profit !== null ? r.take_profit.toFixed(2) : "",
              "", "", "", "",  // Estimasi tidak dipakai di backtest
              r.pnl !== null ? formatRupiah(r.pnl) : "",
              r.entry_date || "",
              r.close_date || "",
              r.hold_period !== null ? (r.hold_period + "d") : ""
            ]);
          });
        } else {
          // MODE SCAN: satu baris per ticker (hanya yang memenuhi strategy sekarang)
          res.rows.forEach(r => {
            let cleanTicker = r.ticker.replace(/\*/g, '');
            table.row.add([
              '<a href="https://stockbit.com/symbol/' + cleanTicker + '/chartbit" target="_blank">' + r.ticker + '</a>',
              r.price !== null ? r.price.toFixed(2) : "",
              r.entry_price !== null ? r.entry_price.toFixed(2) : "",
              r.stop_loss !== null ? r.stop_loss.toFixed(2) : "",
              r.take_profit !== null ? r.take_profit.toFixed(2) : "",
              r.est_profit_pct !== null ? r.est_profit_pct.toFixed(2) + " %" : "",
              r.est_profit_rp !== null ? formatRupiah(r.est_profit_rp) : "",
              r.est_loss_pct !== null ? r.est_loss_pct.toFixed(2) + " %" : "",
              r.est_loss_rp !== null ? formatRupiah(r.est_loss_rp) : "",
              r.pnl !== null ? formatRupiah(r.pnl) : "",
              r.entry_date || "",
              r.close_date || "",
              r.hold_period !== null ? (r.hold_period + "d") : ""
            ]);
          });
        }

        table.draw();

        // Summary backtest agregat
        if (action === "backtest") {
          if (res.summary && res.summary.length > 0) {
            let totalTrades = 0;
            let netProfit = 0;
            let sumWinrate = 0;
            let sumHold = 0;
            let cntSummary = res.summary.length;
            let exitReasonTotal = {};

            res.summary.forEach(s => {
              totalTrades += s.total_trades;
              netProfit += s.net_profit;
              sumWinrate += s.winrate;
              sumHold += s.avg_holding_days;
              for (let k in s.exit_reason_count) {
                exitReasonTotal[k] = (exitReasonTotal[k] || 0) + s.exit_reason_count[k];
              }
            });

            let avgWinrate = cntSummary ? (sumWinrate / cntSummary) : 0;
            let avgHold = cntSummary ? (sumHold / cntSummary) : 0;

            let amount = $('#scan-form [name=amount]').val();
            let timeframe = $('#scan-form [name=timeframe]').val();
            let text = "";
            text += "Periode Backtest : (start sekitar " + $('#scan-form [name=bt_period]').val() + " sebelum hari ini)\n";
            text += "Timeframe        : " + timeframe + "\n";
            text += "Total Equity Awal: Rp " + formatRupiah(amount) + "\n";
            text += "Strategy         : " + $('select[name=strategy] option:selected').text() + "\n";
            text += "------------------------------\n";
            text += "Total Trades     : " + totalTrades + "\n";
            text += "Avg Winrate      : " + avgWinrate.toFixed(2) + "%\n";
            text += "Avg Holding Time : " + avgHold.toFixed(1) + " Hari\n";
            text += "------------------------------\n";
            text += "Net Profit       : Rp " + formatRupiah(netProfit) + "\n";
            text += "Final Equity (*) : Rp " + formatRupiah(parseFloat(amount) + netProfit) + "\n";
            text += "------------------------------\n";
            text += "Alasan Exit:\n";
            for (let k in exitReasonTotal) {
              text += k + "  " + exitReasonTotal[k] + "\n";
            }

            $('#summary-box').text(text);
          }
        } else {
          $('#summary-box').text("");
        }
      }, "json")
      .fail(function(xhr) {
        alert("Error: " + xhr.responseText);
      });
    }

    $('#btn-scan').on('click', function() {
      submitForm("scan");
    });
    $('#btn-backtest').on('click', function() {
      submitForm("backtest");
    });
  </script>
</body>
</html>
